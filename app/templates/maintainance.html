<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Maintenance Bills</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f7f7;
      padding: 20px;
    }

    h2 {
      text-align: center;
      color: #333;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      align-items: center;
    }

    .top-bar a {
      text-decoration: none;
      background: #2196F3;
      color: white;
      padding: 8px 14px;
      border-radius: 5px;
    }

    form {
      background: #fff;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    form input, form select {
      padding: 8px;
      margin: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    form button {
      background: #4CAF50;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }

    th {
      background-color: #4CAF50;
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    .status.paid {
      color: green;
      font-weight: bold;
    }

    .status.pending {
      color: red;
      font-weight: bold;
    }

    button.action-btn {
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      color: white;
      margin: 2px;
      cursor: pointer;
    }

    .edit-btn {
      background: #2196F3;
    }

    .mark-paid-btn {
      background: #4CAF50;
    }

    .download-btn {
      background: #FF9800;
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <a href="{{ url_for('main.dashboard') }}">‚Üê Go to Dashboard</a>
    <h2>Maintenance Bills - {{ current_month }}</h2>
    <a class="download-btn" href="{{ url_for('main.download_report', month=current_month) }}">Download Report</a>
  </div>

  <!-- Add Maintenance Bill Form -->
  <form method="POST" action="{{ url_for('main.add_maintenance_bill') }}">
    <label>Flat Number: <input type="text" name="flat_number" required></label>
    <label>Base Amount: <input type="number" name="base_amount" step="0.01" required></label>
    <label>Late Fee: <input type="number" name="late_fee" step="0.01" required></label>
    <label>Month:
      <input type="month" name="month" value="{{ current_month }}" required>
    </label>
    <button type="submit">Add Bill</button>
  </form>

  <!-- Bills Table -->
  <table>
    <thead>
      <tr>
        <th>Bill ID</th>
        <th>Flat</th>
        <th>Month</th>
        <th>Base Amount</th>
        <th>Late Fee</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for bill in bills %}
      <tr data-id="{{ bill.bill_id }}">
        <td>{{ bill.bill_id }}</td>
        <td>{{ bill.flat.flat_number }}</td>
        <td>{{ bill.month }}</td>
        <td class="amount">{{ "%.2f"|format(bill.base_amount) }}</td>
        <td class="late_fee">{{ "%.2f"|format(bill.late_fee) }}</td>
        <td class="status {{ bill.status|lower }}">{{ bill.status }}</td>
        <td>
          <button class="action-btn edit-btn" onclick="editRow(this)">Edit</button>
          {% if bill.status != 'Paid' %}
          <button class="action-btn mark-paid-btn" onclick="markPaid(this)">Mark Paid</button>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
    function editRow(btn) {
      const row = btn.closest("tr");
      const billId = row.dataset.id;
      const amountCell = row.querySelector(".amount");
      const lateFeeCell = row.querySelector(".late_fee");
      const statusCell = row.querySelector(".status");

      const currentAmount = parseFloat(amountCell.textContent);
      const currentLateFee = parseFloat(lateFeeCell.textContent);
      const currentStatus = statusCell.textContent.trim();

      const newAmount = prompt("Enter new base amount:", currentAmount);
      if (newAmount === null || isNaN(newAmount)) return alert("Invalid base amount");

      const newLateFee = prompt("Enter new late fee:", currentLateFee);
      if (newLateFee === null || isNaN(newLateFee)) return alert("Invalid late fee");

      const newStatus = prompt("Enter new status (Paid or Pending):", currentStatus);
      if (newStatus !== "Paid" && newStatus !== "Pending") return alert("Invalid status");

      fetch(`/edit_bill_amount/${billId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          base_amount: parseFloat(newAmount),
          late_fee: parseFloat(newLateFee),
          status: newStatus
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.message) {
          amountCell.textContent = parseFloat(newAmount).toFixed(2);
          lateFeeCell.textContent = parseFloat(newLateFee).toFixed(2);
          statusCell.textContent = newStatus;
          statusCell.className = `status ${newStatus.toLowerCase()}`;

          if (newStatus === "Paid") {
            const markBtn = row.querySelector(".mark-paid-btn");
            if (markBtn) markBtn.remove();
          }
        } else {
          alert("Update failed: " + data.error);
        }
      });
    }

    function markPaid(btn) {
      const row = btn.closest("tr");
      const billId = row.dataset.id;

      fetch(`/update_bill_status/${billId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ status: "Paid" })
      })
      .then(res => res.json())
      .then(data => {
        if (data.message) {
          const statusCell = row.querySelector(".status");
          statusCell.textContent = "Paid";
          statusCell.className = "status paid";
          btn.remove();
        } else {
          alert("Mark Paid failed: " + data.error);
        }
      });
    }
  </script>
</body>
</html>