{% extends 'base.html' %}
{% block title %}Pending Dues - Apartment Maintenance{% endblock %}

{% block content %}
<div class="container mt-5">

  <h2>Pending Dues</h2>
  
  <form method="get" action="{{ url_for('main.pending_dues') }}" class="mb-4">
    <label for="month">Select Month:</label>
    <input type="month" id="month" name="month" value="{{ selected_month }}">
    <button type="submit" class="btn btn-sm btn-primary">Filter</button>
  </form>

  {% if message %}
    <div class="alert alert-warning">{{ message }}</div>
  {% endif %}
  {% if email_results %}
    <div class="alert alert-info mt-3">
      <h5>Email Send Results</h5>
      <table class="table table-bordered table-sm">
        <thead class="table-light">
          <tr>
            <th>Flat</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for flat_num, status in email_results %}
          <tr>
            <td>{{ flat_num }}</td>
            <td>{{ status }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
  {% if pending_data %}
    <form action="{{ url_for('main.send_due_emails') }}" method="post">
      <input type="hidden" name="month" value="{{ selected_month }}">
      <table class="table table-striped table-bordered">
        <thead class="table-dark">
          <tr>
            <th style="width: 60px; text-align:center;">
              <input type="checkbox" id="select-all" title="Select All">
            </th>
            <th>Flat</th>
            <th>Owner / Tenant</th>
            <th>Month</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody>
          {% for item in pending_data %}
            {% for bill in item.bills %}
            <tr>
              <td style="text-align:center;">
                <input type="checkbox" name="selected_flats" value="{{ item.flat.flat_id }}">
              </td>
              <td>{{ item.flat.flat_number }}</td>
              <td>
                {% if item.flat.tennant_name %}
                  <strong>{{ item.flat.tennant_name }}</strong> (Tenant)<br>
                  ğŸ“ {{ item.flat.tennant_contact }}<br>
                  âœ‰ï¸ {{ item.flat.tennant_email or 'No email' }}
                {% else %}
                  <strong>{{ item.flat.owner_name }}</strong> (Owner)<br>
                  ğŸ“ {{ item.flat.owner_contact }}<br>
                  âœ‰ï¸ {{ item.flat.owner_email or 'No email' }}
                {% endif %}
              </td>
              <td>{{ bill.month }}</td>
              <td>â‚¹{{ "%.2f"|format(bill.base_amount) }}</td>
            </tr>
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>
      <div class="mt-3">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-envelope"></i> Send Reminder Emails
        </button>
        <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary ms-2">â† Back to Dashboard</a>
      </div>
    </form>
  {% else %}
    <p class="text-success mt-4">No pending dues ğŸ‰</p>
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary mt-3">â† Back to Dashboard</a>
  {% endif %}

</div>
<script>
document.getElementById('select-all')?.addEventListener('change', function(e) {
  const checkboxes = document.querySelectorAll('input[name="selected_flats"]');
  checkboxes.forEach(cb => cb.checked = e.target.checked);
});
</script>
{% endblock %}